<apex:page docType="html-5.0" sidebar="false" tabStyle="DEN_Config__c" controller="DEN_ConfigController">
    <apex:includeScript value="https://code.jquery.com/jquery-1.12.3.min.js"/>
    <script type="text/javascript">
    	j$ = jQuery.noConflict();
    	j$(document).ready(function() {
            var datePicklist = j$('[class*=dateSelected]');
            var weekdayPicklist = j$('[class*=weekdaySelected]');
            var endhsection = j$('[class*=endHselected]');
            var starthsection = j$('[class*=startHselected]');
            var starth = j$('[id*=startHselected]');
            var endh = j$('[id*=endHselected]');
            var weekday = j$('[id*=weekdaySelected]');
            var day = j$('[id*=dateSelected]');
            clearvalue(weekday);
            datePicklist.hide();  	
            endhsection.hide();
            starthsection.hide();                                        
                   
            function filterStartHours(filterValue) {                
            	j$('[class*=summaryRow]').each(function() {
                    var value=j$(this).find('[class*=summaryColumn]').eq(0).text();
                    var start=j$(this).find('[class*=summaryColumn]').eq(1).text();
                    var end=j$(this).find('[class*=summaryColumn]').eq(2).text();
					if(filterValue==value) {
                    	hideBetween(starth,start,end);                                                
                    }                    
                });                
            }
            
            function filterEndHours(filterValue, startday) {                
                hideBetween(endh,0,+startday);                                                
            	j$('[class*=summaryRow]').each(function() {
                    var value=j$(this).find('[class*=summaryColumn]').eq(0).text();
                    var start=j$(this).find('[class*=summaryColumn]').eq(1).text();
                    var end=j$(this).find('[class*=summaryColumn]').eq(2).text();                      
					if(filterValue==value && start>+startday) {                        
                    	hideBetween(endh,start,endh.find('option').size());
                    }                    
                });                
            }            
            
            function hideBetween(field, start, end) {                
                field.find('option').each(function() {                                       
                    if(+j$(this).val() >= +start && +j$(this).val() <= +end) {
                        j$(this).hide();
                    }
                });				
            }
            
            function showAll(field) {
                field.find('option').each(function() {
                    j$(this).show();
                });
            }                                        
            
            weekday.change(function() {
                showAll(starth);                
                starthsection.show();
				clearvalue(starth);            
                filterStartHours(weekday.val());
                endhsection.hide();
            });
            
            day.change(function() {
				showAll(starth);                
                starthsection.show();
				clearvalue(starth);                           
                var formattedDate = convertFormat(day.val());
				filterStartHours(formattedDate);                
                endhsection.hide();                
            });
            
            function convertFormat(date) {                
                var splitted = date.split("-",3);                
                return (splitted[2]+"/"+splitted[1]+"/"+splitted[0]);
            }
            
            j$('input:radio[name$=configType]').change(function() {                                
                datePicklist.toggle();
                weekdayPicklist.toggle();
            });
            
            starth.change(function() {                
                showAll(endh);
            	endhsection.show();                                                
				endh.val(+starth.val()+1); 
                if (datePicklist.is(':visible')) {                    
                    filterEndHours(convertFormat(day.val()),starth.val());
                } else {                    
                    filterEndHours(weekday.val(),starth.val());
                }                
            });                                    

            function clearvalue(field) {                
                field.val('');
            }            
		});
    </script>
    <apex:form >
        <apex:pageMessages id="pageMessage"/>
        <apex:pageBlock title="Working hours configuration for {!$User.FirstName} {!$User.LastName}">
            <apex:pageBlockButtons >
                <apex:commandButton value="Save" action="{!save}"/>
                <apex:commandButton value="Cancel" action="{!cancel}"/>
            </apex:pageBlockButtons>
                        
            <apex:pageBlockSection title="Please adjust your setup:" collapsible="false" columns="1" >
                <apex:pageBlockSectionItem > 
                    <apex:selectRadio value="{!configType}" id="configType">
                        <apex:selectOptions value="{!configTypeItems}"/>
                	</apex:selectRadio>    
                </apex:pageBlockSectionItem>
			</apex:pageBlockSection>
            
            <apex:pageBlockSection showHeader="false" columns="1" >                
                <apex:pageBlockSectionItem dataStyleClass="weekdaySelected" labelStyleClass="weekdaySelected">
                    <apex:outputLabel for="weekdaySelected">Select Weekday:</apex:outputLabel>
                    <apex:selectList size="1" multiselect="false" value="{!weekdaySelected}" id="weekdaySelected">
                        <apex:selectOptions value="{!weekdays}"></apex:selectOptions>
                    </apex:selectList>
                </apex:pageBlockSectionItem>    
                                                 
                <apex:pageBlockSectionItem dataStyleClass="dateSelected" labelStyleClass="dateSelected"> 
                    <apex:outputLabel for="dateSelected">Select Date:</apex:outputLabel>
                    <apex:input type="date" value="{!dateSelected}" id="dateSelected"/>
                </apex:pageBlockSectionItem>                                                                                         
            </apex:pageBlockSection>
                
            <apex:pageBlockSection showHeader="false" columns="1" id="HourSelection">
                <apex:pageBlockSectionItem dataStyleClass="startHselected" labelStyleClass="startHselected">
                    <apex:outputText >Starting Hour:</apex:outputText>
                    <apex:selectList size="1" multiselect="false" value="{!startHselected}" id="startHselected">
                        <apex:selectOptions value="{!startHours}"></apex:selectOptions>
                    </apex:selectList>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem dataStyleClass="endHselected" labelStyleClass="endHselected">                    
                    <apex:outputText >Ending Hour:</apex:outputText>
                    <apex:selectList size="1" multiselect="false" value="{!endHselected}" id="endHselected">
                        <apex:selectOptions value="{!endHours}"></apex:selectOptions>
                    </apex:selectList>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem id="confirmConfig">
                    <apex:commandButton value="Add" action="{!addToSummary}" reRender="Summary,pageMessage" oncomplete="alert('tu chce wyczyscic dany weekday/day');return false;"/>
                </apex:pageBlockSectionItem>                
            </apex:pageBlockSection>  
            
            <apex:pageBlockSection title="Summary:" collapsible="false" columns="1" id="Summary" >
                <apex:pageBlockSectionItem >
                    <apex:pageBlockTable var="con" value="{!configWeekDay}" columnClasses="summaryColumn" rowClasses="summaryRow">
                        <apex:column value="{!con.Weekday__c}"/>
                        <apex:column value="{!con.StartingHour__c}"/>
                        <apex:column value="{!con.EndingHour__c}"/>    
                        <apex:column headerValue="Action">
                            <apex:commandLink value="Delete" action="{!removeRow}" reRender="Summary">
                                <apex:param assignTo="{!rowWeekDay}" value="{!con.Weekday__c}" name="rowWeekDay"/>
                                <apex:param assignTo="{!rowStartH}" value="{!con.StartingHour__c}" name="rowStartH"/>
                                <apex:param assignTo="{!rowEndH}" value="{!con.EndingHour__c}" name="rowEndH"/>    
                                <apex:param assignTo="{!rowDate}" value="{!TEXT(con.Date__c)}" name="rowDate"/>
                            </apex:commandLink>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem >
                    <apex:pageBlockTable var="con2" value="{!configDate}" columnClasses="summaryColumn" rowClasses="summaryRow">
                        <apex:column value="{!con2.Date__c}"/>
                        <apex:column value="{!con2.StartingHour__c}"/>
                        <apex:column value="{!con2.EndingHour__c}"/>                        
                        <apex:column headerValue="Action">
                            <apex:commandLink value="Delete" action="{!removeRow}" reRender="Summary">
                                <apex:param assignTo="{!rowDate}" value="{!TEXT(con2.Date__c)}" name="rowDate"/>
                                <apex:param assignTo="{!rowStartH}" value="{!con2.StartingHour__c}" name="rowStartH"/>
                                <apex:param assignTo="{!rowEndH}" value="{!con2.EndingHour__c}" name="rowEndH"/>     
                                <apex:param assignTo="{!rowWeekDay}" value="{!con2.Weekday__c}" name="rowWeekDay"/>
                            </apex:commandLink>
                        </apex:column>                        
                    </apex:pageBlockTable>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
        
    	</apex:pageBlock>
    </apex:form>	
</apex:page>